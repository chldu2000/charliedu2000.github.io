<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="零歌"><meta name="copyright" content="零歌"><meta name="generator" content="Hexo 6.3.0"><meta name="theme" content="hexo-theme-yun"><title>如何拥有一辆属于自己的三蹦子 | 愚人而已</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/afool.svg"><link rel="mask-icon" href="/afool.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"afool.top","root":"/","title":"愚人而已","version":"1.10.9","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"fireworks":{"colors":null},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="alternate" href="/atom.xml" title="愚人而已" type="application/atom+xml"><meta name="description" content="你是否经常感到空虚寂寞、百无聊赖？你是否缺少陪伴、倍感不安、想要在这喧嚣的城市里寻找一份慰藉？ 毫无疑问，拥有属于自己的车、房可以在物质层面缓解这些焦虑（确信）。买房太难了，所以就先从车开始吧。 三轮车也是车打住，我要说的并不是这种车：   或者这种车：  废话，你以为我买得起？ 而是这种：  什么？这不行？气抖冷，难道三轮车就不是车？玩具车就不能给慰藉了？">
<meta property="og:type" content="article">
<meta property="og:title" content="如何拥有一辆属于自己的三蹦子">
<meta property="og:url" content="https://afool.top/learning/how-to-own-a-tricycle/">
<meta property="og:site_name" content="愚人而已">
<meta property="og:description" content="你是否经常感到空虚寂寞、百无聊赖？你是否缺少陪伴、倍感不安、想要在这喧嚣的城市里寻找一份慰藉？ 毫无疑问，拥有属于自己的车、房可以在物质层面缓解这些焦虑（确信）。买房太难了，所以就先从车开始吧。 三轮车也是车打住，我要说的并不是这种车：   或者这种车：  废话，你以为我买得起？ 而是这种：  什么？这不行？气抖冷，难道三轮车就不是车？玩具车就不能给慰藉了？">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/09/26/ln7xH36LUbiZc9O.png">
<meta property="og:image" content="https://i.loli.net/2021/09/26/GHQzW9Xd73DqvNF.png">
<meta property="og:image" content="https://i.loli.net/2021/09/26/E3CDyXLPTh5qFfS.png">
<meta property="og:image" content="https://i.loli.net/2021/09/26/En4idsW7mopQIlw.png">
<meta property="og:image" content="https://i.loli.net/2021/09/26/zn1dQPEOVopC6Nb.png">
<meta property="og:image" content="https://i.loli.net/2021/09/26/sag6u8wGnzUjeJI.png">
<meta property="og:image" content="https://i.loli.net/2021/09/26/3bd725qZpOjQaWt.png">
<meta property="og:image" content="https://i.loli.net/2021/09/27/Em4FxIQVOqHk23v.png">
<meta property="og:image" content="https://i.loli.net/2021/09/27/pFOxqZhGQ3ArHud.png">
<meta property="og:image" content="https://i.loli.net/2021/09/27/u2kjTUFf97LInDW.png">
<meta property="article:published_time" content="2021-09-26T10:56:38.000Z">
<meta property="article:modified_time" content="2022-11-07T08:43:40.846Z">
<meta property="article:author" content="零歌">
<meta property="article:tag" content="单片机">
<meta property="article:tag" content="小车">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/09/26/ln7xH36LUbiZc9O.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="零歌"><img width="96" loading="lazy" src="/images/nekosense.jpeg" alt="零歌"></a><div class="site-author-name"><a href="/about/">零歌</a></div><span class="site-name">愚人而已</span><sub class="site-subtitle">以愚者之名攀上顶峰</sub><div class="site-description"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">45</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">5</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">33</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:settings-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><span class="icon iconify" data-icon="ri:rss-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/charliedu2000" title="GitHub" target="_blank" style="color:#6e5494"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=610609902" title="网易云音乐" target="_blank" style="color:#C20C0C"><span class="icon iconify" data-icon="ri:netease-cloud-music-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/22660607" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><span class="icon iconify" data-icon="ri:bilibili-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:charliedu2000@hotmail.com" title="E-Mail" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:mail-line"></span></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="旁友们" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E8%BD%AE%E8%BD%A6%E4%B9%9F%E6%98%AF%E8%BD%A6"><span class="toc-number">1.</span> <span class="toc-text">三轮车也是车</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E9%9B%B6%EF%BC%88%E5%B9%B6%E4%B8%8D%E6%98%AF%EF%BC%89%E5%BC%80%E5%A7%8B%E7%9A%84%E9%80%A0%E4%B8%89%E8%BD%AE%E7%94%9F%E6%B4%BB"><span class="toc-number">2.</span> <span class="toc-text">从零（并不是）开始的造三轮生活</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%B5%E6%9C%BA%E9%A9%B1%E5%8A%A8"><span class="toc-number">2.1.</span> <span class="toc-text">电机驱动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%93%9D%E7%89%99%E9%81%A5%E6%8E%A7%E4%B8%8E%E4%B8%B2%E5%8F%A3%E9%80%9A%E4%BF%A1"><span class="toc-number">2.2.</span> <span class="toc-text">蓝牙遥控与串口通信</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%93%E4%BD%A0%E6%8B%A5%E6%9C%89%E4%BA%86%E7%8E%B0%E6%88%90%E7%9A%84%E8%BD%AE%E5%AD%90"><span class="toc-number">3.</span> <span class="toc-text">当你拥有了现成的轮子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%A6%E8%BA%AB%E5%8A%9F%E8%83%BD"><span class="toc-number">3.1.</span> <span class="toc-text">车身功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E6%9E%84%E6%88%90"><span class="toc-number">3.2.</span> <span class="toc-text">程序构成</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F%E5%92%8C%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E"><span class="toc-number">3.2.1.</span> <span class="toc-text">系统变量和函数声明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.2.2.</span> <span class="toc-text">系统初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%A6%E8%BA%AB%E6%8C%89%E9%94%AE%E5%8A%9F%E8%83%BD"><span class="toc-number">3.2.3.</span> <span class="toc-text">车身按键功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E5%8A%A8%E6%8E%A7%E5%88%B6%E4%B8%AD%E6%9E%A2"><span class="toc-number">3.2.4.</span> <span class="toc-text">运动控制中枢</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E8%BD%AC%E6%8D%A2"><span class="toc-number">3.2.5.</span> <span class="toc-text">模式转换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%A2%E5%A4%96%E5%92%8C%E8%93%9D%E7%89%99%E9%81%A5%E6%8E%A7"><span class="toc-number">3.2.6.</span> <span class="toc-text">红外和蓝牙遥控</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%81%BF%E9%9A%9C"><span class="toc-number">3.2.7.</span> <span class="toc-text">避障</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%9F%E9%9A%8F"><span class="toc-number">3.2.8.</span> <span class="toc-text">跟随</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="https://afool.top/learning/how-to-own-a-tricycle/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="零歌"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="愚人而已"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">如何拥有一辆属于自己的三蹦子</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="创建时间：2021-09-26 18:56:38" itemprop="dateCreated datePublished" datetime="2021-09-26T18:56:38+08:00">2021-09-26</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="本文字数"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="本文字数">4.8k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读时长"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="阅读时长">18m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%A5%87%E6%80%AA%E7%9A%84%E7%9F%A5%E8%AF%86%E5%A2%9E%E5%8A%A0%E4%BA%86/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">奇怪的知识增加了</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/%E5%8D%95%E7%89%87%E6%9C%BA/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">单片机</span></a><a class="tag-item" href="/tags/%E5%B0%8F%E8%BD%A6/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">小车</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><p>你是否经常感到空虚寂寞、百无聊赖？你是否缺少陪伴、倍感不安、想要在这喧嚣的城市里寻找一份慰藉？</p>
<p>毫无疑问，拥有属于自己的车、房可以在物质层面缓解这些焦虑（确信）。买房太难了，所以就先从车开始吧。</p>
<h2 id="三轮车也是车"><a href="#三轮车也是车" class="headerlink" title="三轮车也是车"></a>三轮车也是车</h2><p>打住，我要说的并不是这种车：</p>
<p><img src="https://i.loli.net/2021/09/26/ln7xH36LUbiZc9O.png" alt="车1网图" loading="lazy"></p>
<p><img src="https://i.loli.net/2021/09/26/GHQzW9Xd73DqvNF.png" alt="车2网图" loading="lazy"></p>
<p>或者这种车：</p>
<p><img src="https://i.loli.net/2021/09/26/E3CDyXLPTh5qFfS.png" alt="蝙蝠车网图" loading="lazy"></p>
<p><del>废话，你以为我买得起？</del></p>
<p>而是这种：</p>
<p><img src="https://i.loli.net/2021/09/26/En4idsW7mopQIlw.png" alt="三蹦子" loading="lazy"></p>
<p>什么？这不行？气抖冷，难道三轮车就不是车？玩具车就不能给慰藉了？</p>
<span id="more"></span>

<h2 id="从零（并不是）开始的造三轮生活"><a href="#从零（并不是）开始的造三轮生活" class="headerlink" title="从零（并不是）开始的造三轮生活"></a>从零（并不是）开始的造三轮生活</h2><p>是这样的，我想搞个小车已经很久了，大概大半年了？早早地就从某宝上买了亚克力板和电机、轮子（所以不算从零开始），准备大干一番，却一直没有动手。因为之前没有接触过单片机，丝毫没有头绪。<del>（懒）</del></p>
<p>事情的转机出现在今年夏季小学期，我们要基于单片机学电子系统设计了。狂喜，有人教了。于是在焊完板子学了一些案例后我们就放假回家了，老师特意说要自己想想选题（不过很多人不一定想了）嗯？这还用想？做车啊！</p>
<p><del>虽然这样说，我还是等到了暑假的最后一周才开始动手。</del></p>
<h3 id="电机驱动"><a href="#电机驱动" class="headerlink" title="电机驱动"></a>电机驱动</h3><p>对于车来说，最基本的是什么？当然是能跑。所以我首先测了电机能不能转。</p>
<p>我用的板子就是之前<a href="https://afool.top/learning/stc-beep-music/">蜂鸣器唱《国际歌》</a>的那块，芯片型号是 IAP15F2K60S2（基本等同于STC15F2K60S2）。板子上有三个拓展接口：EXT、SM 和 485。大概长这样：</p>
<p><img src="https://i.loli.net/2021/09/26/zn1dQPEOVopC6Nb.png" alt="拓展接口" loading="lazy"></p>
<p>最适合拿来控制两个电机的当然是 SM （步进电机）接口，给了一个 VCC 和四个引脚输出（EXT 接口蓝牙要用，485 只给了两个引脚和 GND）。直接把电机接到 VCC 和另一个引脚，没问题，但是接两个引脚给高低电平电机就不转，设推挽输出也没用，我是没想明白怎么回事。实在太逊了，这个样子连电机反转都搞不了，还怎么跑两个电机啊？</p>
<p>办法总比困难多，博闻强识的我（大嘘）怎么能想不到解决方案呢？好吧，其实是搜索引擎帮大忙。我借助了双路 L9110S 电机驱动来控制电机。</p>
<p><img src="https://i.loli.net/2021/09/26/sag6u8wGnzUjeJI.png" alt="电机驱动" loading="lazy"></p>
<p>这样就可以做到用 SM 的 VCC 和 485 的 GND 供电，用 S1 到 S4 控制两个电机。四个引脚分别接图里下方的 A-1A 这些。A-1A 和 A-1B 控制 Motor A，Motor A连接到一个电机的两端，Motor B 同理。嗯，完美解决。</p>
<p>让小车按命令动起来的话当然要写程序了，先给小车运动状态的基本定义：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_MOVE_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_MOVE_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"STC15F2K60S2.H"</span></span>

<span class="token comment">// 接电机的引脚</span>
sbit s1 <span class="token operator">=</span> P4 <span class="token operator">^</span> <span class="token number">1</span><span class="token punctuation">;</span>
sbit s2 <span class="token operator">=</span> P4 <span class="token operator">^</span> <span class="token number">2</span><span class="token punctuation">;</span>
sbit s3 <span class="token operator">=</span> P4 <span class="token operator">^</span> <span class="token number">3</span><span class="token punctuation">;</span>
sbit s4 <span class="token operator">=</span> P4 <span class="token operator">^</span> <span class="token number">4</span><span class="token punctuation">;</span>

<span class="token comment">// 电机转动方向</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RightMotorStop</span> <span class="token expression">s1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> s2 <span class="token operator">=</span> <span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LeftMotorStop</span> <span class="token expression">s3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> s4 <span class="token operator">=</span> <span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RightMotorFWD</span> <span class="token expression">s1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> s2 <span class="token operator">=</span> <span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LeftMotorFWD</span> <span class="token expression">s3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> s4 <span class="token operator">=</span> <span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RightMotorREV</span> <span class="token expression">s1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> s2 <span class="token operator">=</span> <span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LeftMotorREV</span> <span class="token expression">s3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> s4 <span class="token operator">=</span> <span class="token number">1</span></span></span>

<span class="token comment">// 运动和停止</span>
<span class="token keyword">void</span> <span class="token function">Forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Backward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TurnLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TurnRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">VStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 初始化</span>
<span class="token keyword">void</span> <span class="token function">MoveInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></code></pre>

<p><del>分别给高低电平应该能看懂吧？</del></p>
<p>函数实现：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"move.h"</span></span>
<span class="token comment">// 前进</span>
<span class="token keyword">void</span> <span class="token function">Forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	LeftMotorFWD<span class="token punctuation">;</span>
	RightMotorFWD<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 后退</span>
<span class="token keyword">void</span> <span class="token function">Backward</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	LeftMotorREV<span class="token punctuation">;</span>
	RightMotorREV<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 左转</span>
<span class="token keyword">void</span> <span class="token function">TurnLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	LeftMotorREV<span class="token punctuation">;</span>
	RightMotorFWD<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 右转</span>
<span class="token keyword">void</span> <span class="token function">TurnRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	LeftMotorFWD<span class="token punctuation">;</span>
	RightMotorREV<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 停车</span>
<span class="token keyword">void</span> <span class="token function">VStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	LeftMotorStop<span class="token punctuation">;</span>
	RightMotorStop<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 初始化，s1 到 s4 推挽输出</span>
<span class="token keyword">void</span> <span class="token function">MoveInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	P4M0 <span class="token operator">=</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
	P4M1 <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	<span class="token comment">//P0 = 0;</span>
	<span class="token function">VStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>我觉得这些都算得上言简意赅（叉腰），就不多解释了。</p>
<h3 id="蓝牙遥控与串口通信"><a href="#蓝牙遥控与串口通信" class="headerlink" title="蓝牙遥控与串口通信"></a>蓝牙遥控与串口通信</h3><p>小车能动了，但是我们还需要控制。我最开始的想法就是做遥控，能用手机直接遥控就再好不过了。手机遥控？那就用蓝牙！</p>
<p>遥控器程序去手机的应用商店里搜“蓝牙串口”，最好是带按钮编辑的那种，一搜一大把，所以就先不关心了。</p>
<p>小车的蓝牙接收我是用 HC-06 来做的。</p>
<p>老师给出的样例里面有用到蓝牙串口通信的，遂“参考”之。</p>
<blockquote>
<p>STC15F2K60S2 系列单片机有2个高速异步串行通信端口，每个串口由2个数据缓冲器、一个移位寄存器、一个串行控制寄存器和一个波特率发生器等组成。</p>
<p>串口1已被用于下载电路，故本案例使用的是串口2来进行与蓝牙的通信。从芯片引脚电路图中，我们可以找到串口2对应的收发引脚分别为 P1.0 和 P1.1，将其的“接受”端和蓝牙模块的“发送”端相连，“发送”端和蓝牙模块的“接收端”端相连，再对应连接 VCC 和 GND 即实现了物理上电路的连通。</p>
<p>串口2只能使用定时器2作为波特率发生器，根据芯片使用手册的说明设置好定时器后，只要将要发送的数据写到 SBUF2 中，串口即自动发送缓存中的数据。</p>
<p><img src="https://i.loli.net/2021/09/26/3bd725qZpOjQaWt.png" alt="连接图示" loading="lazy"></p>
<p>——湖大超星 电子系统设计与创新基础训练 基于Andriod的数据采集系统</p>
</blockquote>
<p>如上所示，使用串口2进行蓝牙通信，串口2只能用定时器2作为波特率发生器，所以先初始化定时器：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">Uart2Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token comment">// 9600bps@11.0592MHz</span>
<span class="token punctuation">&#123;</span>
	S2CON <span class="token operator">=</span> <span class="token number">0x50</span><span class="token punctuation">;</span> <span class="token comment">// 8位数据，可变波特率</span>
	AUXR <span class="token operator">|=</span> <span class="token number">0x04</span><span class="token punctuation">;</span> <span class="token comment">// 定时器2时钟为Fosc，即1T</span>
	T2L <span class="token operator">=</span> <span class="token number">0xE0</span><span class="token punctuation">;</span>   <span class="token comment">// 设定定时初值</span>
	T2H <span class="token operator">=</span> <span class="token number">0xFE</span><span class="token punctuation">;</span>   <span class="token comment">// 设定定时初值</span>
	AUXR <span class="token operator">|=</span> <span class="token number">0x10</span><span class="token punctuation">;</span> <span class="token comment">//启动定时器2</span>
	IE2 <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
	P_SW2 <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	EA <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>前面有注释的都是 STC-ISP 软件自动生成的，最后三句大概是中断使能、外设切换等<del>，没怎么看懂</del>。</p>
<p>然后是用于读取串口2接收数据的中断函数：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">UART2_Interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> interrupt <span class="token number">8</span> <span class="token comment">// 中断8，用于串口2</span>
<span class="token punctuation">&#123;</span>  
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> temp<span class="token punctuation">;</span>	
	
    <span class="token comment">// 检查串口2控制寄存器</span>
    <span class="token comment">// 将1字节的新数据赋给 ReceivedData</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>S2CON<span class="token operator">&amp;</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0x01</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		S2CON <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token number">0x01</span><span class="token punctuation">;</span>
		temp <span class="token operator">=</span> S2BUF<span class="token punctuation">;</span>
		ReceivedData<span class="token operator">=</span>temp<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>	</code></pre>

<p><del>这里似乎可以不用 <code>temp</code>。</del></p>
<p><code>ReceivedData</code> 是个 <code>unsigned char</code> 型的全局变量。在手机的蓝牙串口应用里编辑按钮发送不同数据，根据 <code>ReceivedData</code> 来调用小车的运动控制函数就能实现遥控。这部分程序就不写出来了，<code>switch</code> 或者 <code>if</code> 判断就行。</p>
<p><del>现在一看好简单啊！那为什么我暑假里写了好几天？</del></p>
<h2 id="当你拥有了现成的轮子"><a href="#当你拥有了现成的轮子" class="headerlink" title="当你拥有了现成的轮子"></a>当你拥有了现成的轮子</h2><p><strong>这部分可能不太具有复现性（湖大信息院学生除外，毕竟有老师给的 BSP）。</strong></p>
<p>上面这些是在八月的最后两三天完成的，一边摸鱼一边写程序，算是完成了蓝牙遥控小车的功能，想着就这样吧，也算个设计了，就这样交差。</p>
<p>令我没想到的是，暑假回来之后的下半个小学期，老师给出了一套功能完备的 BSP （Board Support Package，板级支持包），里面有板子上各种外设的驱动程序。比方说要让数码管显示一个数字，原来你需要这样：写段选、写位选、设置推挽输出、引脚赋值、循环内刷新……现在你只需要这样：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">DisplayerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// 显示模块初始化</span>
<span class="token function">SetDisplayerArea</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 只用数码管最后一位</span>
<span class="token function">Seg7Print</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 数码管最后一位显示1</span></code></pre>

<p>初始化之后想显示什么直接调用 <code>Seg7Print()</code> 就行，十分快捷。</p>
<p>有了这样一套轮子，大家想做什么直接调库函数就行，完全不需要向我之前那样从定时器和中断开始写。于是同学们纷纷变身缝合怪，恨不得把所有模块都加到自己的设计中。</p>
<p><del>坏了，卷起来了。</del></p>
<p>没办法，我也只能多搞点东西了。先把蓝牙遥控换成了 BSP 的实现，加了上锁功能。此外在小车上加什么好呢？在咨询了<a target="_blank" rel="noopener" href="https://blog.csdn.net/dasifhoaisfg?spm=1001.2014.3001.5509">隔壁老王</a>后，我确定了“超声波”这个方向，避障什么的自然是少不了，跟随式行李箱也有点意思。完成这些之后我又附加了一个红外遥控的模式。</p>
<p>嗯……比我的最初想法丰富多了……</p>
<h3 id="车身功能"><a href="#车身功能" class="headerlink" title="车身功能"></a>车身功能</h3><p><img src="https://i.loli.net/2021/09/27/Em4FxIQVOqHk23v.png" alt="车身功能" loading="lazy"></p>
<h3 id="程序构成"><a href="#程序构成" class="headerlink" title="程序构成"></a>程序构成</h3><p>小车整体的思想是依托 BSP 提供的<strong>设置事件回调函数</strong>的功能，持续获取外部和车身命令，维护几个系统变量，根据命令和这些变量判断当前小车应该执行的动作。</p>
<p><del>就没必要给整体流程图了吧？</del></p>
<p>由于 BSP 是学校老师写的，且其中函数实现被封装进了库文件，我就不太好意思上传了，只讲一下整体的结构和我自己写的函数吧。</p>
<h4 id="系统变量和函数声明"><a href="#系统变量和函数声明" class="headerlink" title="系统变量和函数声明"></a>系统变量和函数声明</h4><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// main.h</span>
<span class="token comment">// 老师写的数码管显示码表就略过了</span>

<span class="token comment">/**
 * 提供四种模式：
 * 1. 红外遥控
 * 2. 蓝牙串口遥控
 * 3. 超声波避障
 * 4. 跟随/保持距离
 * 其中红外和蓝牙串口模式的运动状态均由 Remote() 控制
 * 避障模式的运动状态由 AutoMove(int i) 控制，跟随模式的运动状态由 Follow(int i) 控制
 * 系统利用 TenMsCallback()，每 10ms 进行运动控制，根据当前模式调用上述三个函数中的一个
 */</span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> rxd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>		  <span class="token comment">// 红外和蓝牙接收的数据</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> rxdHead <span class="token operator">=</span> <span class="token number">0xFA</span><span class="token punctuation">;</span> <span class="token comment">// 蓝牙校验，为配合红外的数据头校验，不特意使用 SetUart2Rxd() 设置</span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> flag<span class="token punctuation">;</span>			<span class="token comment">// 标志位，是否允许操作，为1时允许操作</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> speedState<span class="token punctuation">;</span>	<span class="token comment">// PWM 控制标志</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> speedControl<span class="token punctuation">;</span> <span class="token comment">// 速度控制参数，将电机转速降为全速的 1/speedControl</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> speedLevel<span class="token punctuation">;</span>	<span class="token comment">// 速度档位，数字越大速度越快</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> dirFlag<span class="token punctuation">;</span>		<span class="token comment">// 避障转向选择</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> mode<span class="token punctuation">;</span>			<span class="token comment">// 模式标志</span>

<span class="token keyword">void</span> <span class="token function">ChangeSpeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   <span class="token comment">// 更改速度档位</span>
<span class="token keyword">void</span> <span class="token function">Remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		   <span class="token comment">// 遥控</span>
<span class="token keyword">void</span> <span class="token function">AutoMove</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 避障</span>
<span class="token keyword">void</span> <span class="token function">Follow</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>	   <span class="token comment">// 维持距离</span>
<span class="token keyword">void</span> <span class="token function">ModeBTRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 蓝牙遥控模式初始化</span>
<span class="token keyword">void</span> <span class="token function">ModeIRRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 红外遥控模式初始化</span>
<span class="token keyword">void</span> <span class="token function">ModeAuto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   <span class="token comment">// 避障模式初始化</span>
<span class="token keyword">void</span> <span class="token function">ModeFollow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   <span class="token comment">// 跟随&amp;控制距离模式初始化</span>
<span class="token keyword">void</span> <span class="token function">SwitchModes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   <span class="token comment">// 切换模式</span>
<span class="token keyword">void</span> <span class="token function">KeyCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   <span class="token comment">// 按键事件回调函数</span>
<span class="token keyword">void</span> <span class="token function">Uart2Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 蓝牙接收数据回调函数，仅处理解锁上锁，运动控制被 TenMsCallback() 接管</span>
<span class="token keyword">void</span> <span class="token function">IRCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   <span class="token comment">// 红外接收数据回调函数，仅处理解锁上锁，运动控制被 TenMsCallback() 接管</span>
<span class="token keyword">void</span> <span class="token function">TenMsCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 10ms 回调，实现电机转速控制</span></code></pre>

<p>以上函数均在 <code>main.c</code> 中实现，下面出现的没有在此处声明的函数都来自老师的 BSP。</p>
<h4 id="系统初始化"><a href="#系统初始化" class="headerlink" title="系统初始化"></a>系统初始化</h4><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">Key_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">// 按键初始化</span>
	<span class="token function">DisplayerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 显示模块初始化</span>
	<span class="token function">SetDisplayerArea</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用数码管范围</span>
	<span class="token function">BeepInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">// 蜂鸣器初始化</span>

	<span class="token function">SetEventCallBack</span><span class="token punctuation">(</span>enumEventKey<span class="token punctuation">,</span> KeyCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>	   <span class="token comment">// 设置按键回调函数，本机按键包括模式切换和上锁解锁</span>
	<span class="token function">SetEventCallBack</span><span class="token punctuation">(</span>enumEventSys10mS<span class="token punctuation">,</span> TenMsCallback<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 每 10ms 进行运动控制</span>

	speedState <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 给PWM控制位赋初值</span>
	speedLevel <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 默认速度档位</span>
	flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>		<span class="token comment">// 启动时未上锁</span>
	<span class="token function">MoveInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 设置 s1 到 s4 推挽输出</span>

	<span class="token function">ModeIRRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 默认启动红外遥控模式，即模式0</span>

	<span class="token function">MySTC_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">MySTC_OS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">LedPrint</span><span class="token punctuation">(</span><span class="token punctuation">(</span>flag <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> mode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用 LED7 显示 flag 状态，亮起时表示未上锁</span>
											 <span class="token comment">// LED0、1、2、3分别表示模式0、1、2、3</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="车身按键功能"><a href="#车身按键功能" class="headerlink" title="车身按键功能"></a>车身按键功能</h4><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 按下车机按键的回调函数</span>
<span class="token keyword">void</span> <span class="token function">KeyCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token comment">// 按下 key1 上锁解锁</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetKeyAct</span><span class="token punctuation">(</span>enumKey1<span class="token punctuation">)</span> <span class="token operator">==</span> enumKeyPress<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">VStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		flag <span class="token operator">=</span> <span class="token operator">!</span>flag<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// 按下 key2 切换模式</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetKeyAct</span><span class="token punctuation">(</span>enumKey2<span class="token punctuation">)</span> <span class="token operator">==</span> enumKeyPress<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">VStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">SwitchModes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="运动控制中枢"><a href="#运动控制中枢" class="headerlink" title="运动控制中枢"></a>运动控制中枢</h4><p>直接控制电机的函数就是之前写的那些。</p>
<p>设置系统 10ms 事件回调函数来控制运动：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 简单的 PWM，将电机转速控制为全速的 1/speedControl</span>
<span class="token keyword">void</span> <span class="token function">TenMsCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token comment">// 未上锁</span>
	<span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>speedState<span class="token punctuation">)</span>
		<span class="token punctuation">&#123;</span>
			<span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token comment">// 根据当前模式选择运动控制函数</span>
			<span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
				<span class="token function">Remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
				<span class="token function">Remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
				<span class="token function">AutoMove</span><span class="token punctuation">(</span><span class="token function">GetUltraSonic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
				<span class="token function">Follow</span><span class="token punctuation">(</span><span class="token function">GetUltraSonic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">default</span><span class="token operator">:</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">else</span>
			<span class="token function">VStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>speedState <span class="token operator">>=</span> speedControl<span class="token punctuation">)</span>
			speedState <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>在程序中，0 &lt;&#x3D; speedState &lt; speedControl。系统每次执行回调函数 speedState 会自加，超出范围后再赋值为0。只有在 speedState 为0时小车才会运动。</p>
<p>系统每执行 speedControl 次回调函数，只会有一次允许小车运动，即调整速度为全速的 1&#x2F;speedControl。改变 speedControl 的值即可改变速度：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 调整速度，speedControl 的值是 3或4-speedLevel，所以speedLevel越大，速度越大</span>
<span class="token keyword">void</span> <span class="token function">ChangeSpeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>speedLevel<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
		speedLevel <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
		speedLevel <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
		speedLevel <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">default</span><span class="token operator">:</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>你问我难道老师没有写速度控制？当然写了，可老师的 PWM 是控制 EXT 接口的，我用不了。步进电机那种从 S1 到 S4 依次扫描下来的方式也做不到控制两个直流电机。那就自己写咯……</p>
<h4 id="模式转换"><a href="#模式转换" class="headerlink" title="模式转换"></a>模式转换</h4><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 在四种模式之间轮换：红外->蓝牙->避障->跟随->红外...</span>
<span class="token keyword">void</span> <span class="token function">SwitchModes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
		<span class="token function">ModeBTRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
		<span class="token function">ModeAuto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
		<span class="token function">ModeFollow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
		<span class="token function">ModeIRRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">default</span><span class="token operator">:</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="红外和蓝牙遥控"><a href="#红外和蓝牙遥控" class="headerlink" title="红外和蓝牙遥控"></a>红外和蓝牙遥控</h4><p>红外遥控和蓝牙遥控都是一套逻辑，遥控器发送的命令数据和对应动作如下：</p>
<table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>动作</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>0xFA,0x00</strong></td>
<td>停车</td>
</tr>
<tr>
<td><strong>0xFA,0x01</strong></td>
<td>前进</td>
</tr>
<tr>
<td><strong>0xFA,0x02</strong></td>
<td>左转</td>
</tr>
<tr>
<td><strong>0xFA,0x03</strong></td>
<td>右转</td>
</tr>
<tr>
<td><strong>0xFA,0x04</strong></td>
<td>后退</td>
</tr>
<tr>
<td><strong>0xFA,0x05</strong></td>
<td>鸣笛</td>
</tr>
<tr>
<td><strong>0xFA,0x06</strong></td>
<td>模式转换</td>
</tr>
<tr>
<td><strong>0xFA,0x07</strong></td>
<td>上锁解锁</td>
</tr>
<tr>
<td><strong>0xFA,0x08</strong></td>
<td>切换速度档位</td>
</tr>
</tbody></table>
<p>红外遥控器就是另一块同样的板子，按下按键发送命令：</p>
<table>
<thead>
<tr>
<th><strong>按键</strong></th>
<th><strong>动作</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Up</strong></td>
<td>前进</td>
</tr>
<tr>
<td><strong>Left</strong></td>
<td>左转</td>
</tr>
<tr>
<td><strong>Right</strong></td>
<td>右转</td>
</tr>
<tr>
<td><strong>Down</strong></td>
<td>后退</td>
</tr>
<tr>
<td><strong>Center</strong></td>
<td>停车</td>
</tr>
<tr>
<td><strong>Key3</strong></td>
<td>不发给小车，用于切换Key1和Key2的模式</td>
</tr>
<tr>
<td><strong>Key1</strong> <strong>模式0</strong></td>
<td>鸣笛</td>
</tr>
<tr>
<td><strong>Key1</strong> <strong>模式1</strong></td>
<td>上锁解锁</td>
</tr>
<tr>
<td><strong>Key2</strong> <strong>模式0</strong></td>
<td>速度控制</td>
</tr>
<tr>
<td><strong>Key2</strong> <strong>模式1</strong></td>
<td>模式转换</td>
</tr>
</tbody></table>
<p>红外遥控器的程序就是简单的按键事件和导航按键事件回调函数，就不贴出来了。</p>
<p>至于蓝牙遥控器……<del>比卷，</del>我又写了个<a target="_blank" rel="noopener" href="https://github.com/charliedu2000/BLESerial">安卓蓝牙遥控器</a>，界面上的按键名就是对应功能。</p>
<p>小车的红外模式、蓝牙模式初始化：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 红外遥控模式初始化</span>
<span class="token keyword">void</span> <span class="token function">ModeIRRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">Seg7Print</span><span class="token punctuation">(</span>speedLevel<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 默认模式下显示速度等级和默认指令</span>
	<span class="token function">IrInit</span><span class="token punctuation">(</span>NEC_R05d<span class="token punctuation">)</span><span class="token punctuation">;</span>								  <span class="token comment">// 设置红外协议基本时间片时长，接收到的数据在回调函数和 Remote() 中再进行内容校验</span>
	<span class="token function">SetIrRxd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rxd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">SetEventCallBack</span><span class="token punctuation">(</span>enumEventIrRxd<span class="token punctuation">,</span> IRCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 蓝牙遥控模式初始化</span>
<span class="token keyword">void</span> <span class="token function">ModeBTRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">Uart2Init</span><span class="token punctuation">(</span><span class="token number">9600</span><span class="token punctuation">,</span> Uart2UsedforEXT<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 将串口2的波特率设为9600，用于 EXT</span>
	<span class="token function">SetUart2Rxd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rxd<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>rxdHead<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将接收到的数据存到 rxd，不在此处设置校验</span>
									   <span class="token comment">// 放到 Remote() 中和红外接收的数据一样用 if 语句校验</span>

	<span class="token function">SetEventCallBack</span><span class="token punctuation">(</span>enumEventUart2Rxd<span class="token punctuation">,</span> Uart2Callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>接收到数据的回调函数：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 红外接收到数据的回调函数</span>
<span class="token keyword">void</span> <span class="token function">IRCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetIrRxNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> rxd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> rxdHead<span class="token punctuation">)</span> <span class="token comment">// 简单校验，剩下的与运动状态有关的指令在 Remote() 中校验</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">Seg7Print</span><span class="token punctuation">(</span>speedLevel<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> rxd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 数码管显示接收到的指令（0到8）</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>rxd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span>
			<span class="token function">VStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SwitchModes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//IrPrint("CodeZone\n", sizeof("CodeZone\n"));</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rxd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">)</span>
			<span class="token function">VStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> flag <span class="token operator">=</span> <span class="token operator">!</span>flag<span class="token punctuation">;</span> <span class="token comment">// 接收到7的时候进行上锁解锁操作</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rxd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span>
			<span class="token function">VStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ChangeSpeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 蓝牙接收到数据的回调函数</span>
<span class="token keyword">void</span> <span class="token function">Uart2Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>rxd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> rxdHead<span class="token punctuation">)</span> <span class="token comment">// 由于蓝牙初始化时不再设置校验，所以在这里简单校验</span>
						   <span class="token comment">// 运动状态指令和红外模式一样在 Remote() 中校验</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">Seg7Print</span><span class="token punctuation">(</span>speedLevel<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> rxd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 数码管显示接收到的指令（0到8）</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>rxd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span>
			<span class="token function">VStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SwitchModes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Uart2Print("CodeZone\n", sizeof("CodeZone\n"));</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rxd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">)</span>
			<span class="token function">VStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> flag <span class="token operator">=</span> <span class="token operator">!</span>flag<span class="token punctuation">;</span> <span class="token comment">// 接收到7的时候进行上锁解锁操作</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rxd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span>
			<span class="token function">VStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ChangeSpeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>遥控模式下的控制：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * 遥控：
 * 现在 Remote() 由 TenMsCallback() 直接调用
 * 这里不再包含上锁解锁等按下后只执行一次的操作
 * 上述操作仅在接收数据事件的回调函数里判断并执行
 */</span>
<span class="token keyword">void</span> <span class="token function">Remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token comment">// 校验数据头</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>rxd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> rxdHead<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>rxd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
			<span class="token function">VStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
			speedControl <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">-</span> speedLevel<span class="token punctuation">;</span>
			<span class="token function">Forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
			speedControl <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">-</span> speedLevel<span class="token punctuation">;</span>
			<span class="token function">TurnLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
			speedControl <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">-</span> speedLevel<span class="token punctuation">;</span>
			<span class="token function">TurnRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
			speedControl <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">-</span> speedLevel<span class="token punctuation">;</span>
			<span class="token function">Backward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
			<span class="token function">SetBeep</span><span class="token punctuation">(</span><span class="token number">440</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="避障"><a href="#避障" class="headerlink" title="避障"></a>避障</h4><p>避障模式的初始化：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 避障模式初始化</span>
<span class="token keyword">void</span> <span class="token function">ModeAuto</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">EXTInit</span><span class="token punctuation">(</span>enumEXTUltraSonic<span class="token punctuation">)</span><span class="token punctuation">;</span>
	dirFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	mode <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>避障模式下的控制：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * 显示距离数值，根据距离选择方向
 * i 为距离值，单位是厘米
 */</span>
<span class="token keyword">void</span> <span class="token function">AutoMove</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">Seg7Print</span><span class="token punctuation">(</span>speedLevel<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> 
			<span class="token punctuation">(</span>i <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>i <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>i <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">,</span> i <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 显示速度等级、与障碍物间的距离</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">20</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		speedControl <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">-</span> speedLevel<span class="token punctuation">;</span>
		<span class="token function">Forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		dirFlag <span class="token operator">=</span> <span class="token operator">!</span>dirFlag<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">&#123;</span>
		speedControl <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">-</span> speedLevel<span class="token punctuation">;</span>
		<span class="token function">SetBeep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 距离值过小时蜂鸣器报警</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>dirFlag<span class="token punctuation">)</span>
			<span class="token function">TurnLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			<span class="token function">TurnRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// 当前可以看作随机转向，复杂情况下可能导致小车找不到可行路径</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>运动逻辑：</p>
<p><img src="https://i.loli.net/2021/09/27/pFOxqZhGQ3ArHud.png" alt="避障模式运动逻辑" loading="lazy"></p>
<p><em>显然控制函数每 10ms 就可能被调用，这个流程图里就没有循环结构了。</em></p>
<p>不得不说这个运动逻辑很有问题。在这个逻辑下，小车遇到障碍时的转向算是随机的，但是在复杂情况下就可能使小车一会儿左转一会儿右转，最后转不出去。让小车始终转向一个方向会好些。</p>
<p>由于硬件限制，我装不上舵机，也装不上多个超声波模块，就只能做到让它避开正前方的障碍了。（连这一个超声波模块都要跟蓝牙模块抢 EXT 接口，换模式还得插拔……）</p>
<h4 id="跟随"><a href="#跟随" class="headerlink" title="跟随"></a>跟随</h4><p>说是跟随，其实就是和障碍物保持一定距离罢了。</p>
<p>模式初始化：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 跟随模式初始化</span>
<span class="token keyword">void</span> <span class="token function">ModeFollow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">EXTInit</span><span class="token punctuation">(</span>enumEXTUltraSonic<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mode <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>该模式下的运动控制：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * 显示距离数值，保持一定距离
 * i 为距离值，单位是厘米
 */</span>
<span class="token keyword">void</span> <span class="token function">Follow</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">Seg7Print</span><span class="token punctuation">(</span>speedLevel<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> 
			<span class="token punctuation">(</span>i <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>i <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>i <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">,</span> i <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 显示速度等级、与障碍物间的距离</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">20</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		speedControl <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">-</span> speedLevel<span class="token punctuation">;</span>
		<span class="token function">Forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		speedControl <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">-</span> speedLevel<span class="token punctuation">;</span>
		<span class="token function">SetBeep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 距离值过小时蜂鸣器报警</span>
		<span class="token function">Backward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">VStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>这个运动逻辑就简单了：</p>
<p><img src="https://i.loli.net/2021/09/27/u2kjTUFf97LInDW.png" alt="跟随模式运动逻辑" loading="lazy"></p>
<p>当然，“跟随”的目标也只限正前方。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>所以我得到了什么呢？一个有四种模式的三蹦子。甚好。最初的目标实现了，这下不会空虚寂寞了（笑）。这个设计也拿了院里竞赛的一等奖，爽到。</p>
<p>当然，这个三蹦子还有很多可以改进的地方，包括一些运动逻辑和硬件的改装等等……嗯，未来可期！</p>
<details><summary>一点负能量的东西……</summary>
关于这门课的得分……自己把设计思路输出出去，还提供了一些技术指导，结果那个同学几乎完全复刻，缝合了他自己原本的设计，比我得分还高……多多少少会感觉心里不舒服……算了算了……
</details>
</div></section><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>零歌</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://afool.top/learning/how-to-own-a-tricycle/" title="如何拥有一辆属于自己的三蹦子">https://afool.top/learning/how-to-own-a-tricycle/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/learning/java-thread-producer-and-consumer/" rel="prev" title="生产者消费者模型"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">生产者消费者模型</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/learning/java-thread/" rel="next" title="Java 中的多线程编程？"><span class="post-nav-text">Java 中的多线程编程？</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>留个爪印吧~</span><br></div><div id="tcomment"></div><script type="module">import { getScript } from '/js/utils.js'

getScript("https://fastly.jsdelivr.net/npm/twikoo@latest/dist/twikoo.all.min.js", () => {
  const twikooConfig = {"enable":true,"envId":"https://twikoo-afool.vercel.app/"}
  twikooConfig.el = '#tcomment'
  twikoo.init(twikooConfig)
}, window.twikoo);</script></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2020 – 2022 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> 零歌</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v6.3.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.9</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></body></html>